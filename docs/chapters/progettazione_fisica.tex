\section{Progettazione fisica}

\subsection*{Utenti e privilegi}
%
% Descrivere, all’interno dell’applicazione, quali utenti sono stati previsti
% con quali privilegi di accesso su quali tabelle, giustificando le scelte
% progettuali.
%

\subsubsection*{Ruoli}

\begin{tabularx}{\linewidth}{|X|X|}
    \hline
    \rowcolor{tblhdrcolor}
    \multicolumn{1}{|c|}{\textbf{Nome}}
                   & \multicolumn{1}{|c|}{\textbf{Privilegi}}
    \\\hline
    Cliente        &                                          \\\hline
    Maschera       &                                          \\\hline
    Amministratore &                                          \\\hline
\end{tabularx}

\subsubsection*{Utenti}

\begin{tabularx}{\linewidth}{|X|X|}
    \hline
    \rowcolor{tblhdrcolor}
    \multicolumn{1}{|c|}{\textbf{Nome}}
                   & \multicolumn{1}{|c|}{\textbf{Ruoli}}
    \\\hline
    cliente        & Cliente                              \\\hline
    maschera       & Maschera                             \\\hline
    amministratore & Amministratore, Cliente              \\\hline
\end{tabularx}

\subsection*{Strutture di memorizzazione}
%
% Compilare la tabella seguente indicando quali tipi di dato vengono
% utilizzati per memorizzare le informazioni di interesse nelle tabelle,
% per ciascuna tabella.
%
\begin{tabularx}{\linewidth}{|X|X|X|}
    \hline
    \multicolumn{3}{|>{\columncolor{tblhdrcolor}}l|}{
    \textbf{Cinema}}                               \\\hline
    \rowcolor{tblhdrcolor}
    \multicolumn{1}{|c|}{\textbf{Colonna}}
     & \multicolumn{1}{|c|}{\textbf{Tipo di dato}}
     & \multicolumn{1}{|c|}{\textbf{Attributi}
        \footnote{PK = primary key, NN = not null, UQ = unique,
            UN = unsigned, AI = auto increment.
            È ovviamente possibile specificare più di un attributo per
            ciascuna colonna.}}
    \\\hline
    id
     & INT
     & PK, NN, AI
    \\ \hline
    indirizzo
     & VARCHAR(128)
     & NN, UQ
    \\ \hline
\end{tabularx}

\begin{tabularx}{\linewidth}{|X|X|X|}
    \hline
    \multicolumn{3}{|>{\columncolor{tblhdrcolor}}l|}{
    \textbf{Sale}}                                 \\\hline
    \rowcolor{tblhdrcolor}
    \multicolumn{1}{|c|}{\textbf{Colonna}}
     & \multicolumn{1}{|c|}{\textbf{Tipo di dato}}
     & \multicolumn{1}{|c|}{\textbf{Attributi}}
    \\\hline
    cinema
     & INT
     & PK, NN
    \\ \hline
    numero
     & INT
     & PK, NN
    \\ \hline
\end{tabularx}

\begin{tabularx}{\linewidth}{|X|X|X|}
    \hline
    \multicolumn{3}{|>{\columncolor{tblhdrcolor}}l|}{
    \textbf{Posti}}                                \\\hline
    \rowcolor{tblhdrcolor}
    \multicolumn{1}{|c|}{\textbf{Colonna}}
     & \multicolumn{1}{|c|}{\textbf{Tipo di dato}}
     & \multicolumn{1}{|c|}{\textbf{Attributi}}
    \\\hline
    cinema
     & INT
     & PK, NN
    \\ \hline
    sala
     & INT
     & PK, NN
    \\ \hline
    fila
     & CHAR(1)
     & PK, NN
    \\ \hline
    numero
     & INT
     & PK, NN
    \\ \hline
\end{tabularx}

\begin{tabularx}{\linewidth}{|X|X|X|}
    \hline
    \multicolumn{3}{|>{\columncolor{tblhdrcolor}}l|}{
    \textbf{Dipendente}}                           \\\hline
    \rowcolor{tblhdrcolor}
    \multicolumn{1}{|c|}{\textbf{Colonna}}
     & \multicolumn{1}{|c|}{\textbf{Tipo di dato}}
     & \multicolumn{1}{|c|}{\textbf{Attributi}}
    \\\hline
    matricola
     & INT
     & PK, NN, AI
    \\ \hline
    nome
     & VARCHAR(45)
     & NN
    \\ \hline
    cognome
     & VARCHAR(45)
     & NN
    \\ \hline
    ruolo
     & ENUM('maschera', 'proiezionista')
     & NN
    \\ \hline
\end{tabularx}

\begin{tabularx}{\linewidth}{|X|X|X|}
    \hline
    \multicolumn{3}{|>{\columncolor{tblhdrcolor}}l|}{
    \textbf{Turni}}                                          \\\hline
    \rowcolor{tblhdrcolor}
    \multicolumn{1}{|c|}{\textbf{Colonna}}
     & \multicolumn{1}{|c|}{\textbf{Tipo di dato}}
     & \multicolumn{1}{|c|}{\textbf{Attributi}}
    \\\hline
    dipendente
     & INT
     & PK, NN
    \\ \hline
    giorno
     & ENUM('lun', 'mar', 'mer', 'gio', 'ven', 'sab', 'dom')
     & PK, NN
    \\ \hline
    inizio
     & TIME
     & PK, NN
    \\ \hline
    durata
     & TIME
     & NN
    \\ \hline
    cinema
     & INT
     & NN
    \\ \hline
\end{tabularx}

\begin{tabularx}{\linewidth}{|X|X|X|}
    \hline
    \multicolumn{3}{|>{\columncolor{tblhdrcolor}}l|}{
    \textbf{Film}}                                 \\\hline
    \rowcolor{tblhdrcolor}
    \multicolumn{1}{|c|}{\textbf{Colonna}}
     & \multicolumn{1}{|c|}{\textbf{Tipo di dato}}
     & \multicolumn{1}{|c|}{\textbf{Attributi}}
    \\\hline
    id
     & INT
     & PK, NN, AI
    \\ \hline
    nome
     & VARCHAR(45)
     & NN
    \\ \hline
    durata
     & TIME
     & NN
    \\ \hline
    casa\_cinematografica
     & VARCHAR(45)
     &
    \\ \hline
    cast
     & VARCHAR(1024)
     &
    \\ \hline
\end{tabularx}

\begin{tabularx}{\linewidth}{|X|X|X|}
    \hline
    \multicolumn{3}{|>{\columncolor{tblhdrcolor}}l|}{
    \textbf{Proiezioni}}                           \\\hline
    \rowcolor{tblhdrcolor}
    \multicolumn{1}{|c|}{\textbf{Colonna}}
     & \multicolumn{1}{|c|}{\textbf{Tipo di dato}}
     & \multicolumn{1}{|c|}{\textbf{Attributi}}
    \\\hline
    cinema
     & INT
     & PK, NN
    \\ \hline
    sala
     & INT
     & PK, NN
    \\ \hline
    data
     & DATE
     & PK, NN
    \\ \hline
    ora
     & TIME
     & PK, NN
    \\ \hline
    prezzo
     & DECIMAL(15,2)
     & NN
    \\ \hline
    film
     & INT
     & NN
    \\ \hline
    proiezionista
     & INT
     &
    \\ \hline
\end{tabularx}

\begin{tabularx}{\linewidth}{|X|X|X|}
    \hline
    \multicolumn{3}{|>{\columncolor{tblhdrcolor}}l|}{
    \textbf{Prenotazioni}}                                    \\\hline
    \rowcolor{tblhdrcolor}
    \multicolumn{1}{|c|}{\textbf{Colonna}}
     & \multicolumn{1}{|c|}{\textbf{Tipo di dato}}
     & \multicolumn{1}{|c|}{\textbf{Attributi}}
    \\\hline
    codice
     & INT
     & PK, NN, AI
    \\ \hline
    transazione
     & VARCHAR(256)
     & NN, UQ
    \\ \hline
    stato
     & ENUM('confermata', 'annullata', 'validata', 'scaduta')
     & NN
    \\ \hline
    cinema
     & INT
     & NN
    \\ \hline
    sala
     & INT
     & NN
    \\ \hline
    fila
     & CHAR(1)
     & NN
    \\ \hline
    numero
     & INT
     & NN
    \\ \hline
    data
     & DATE
     & NN
    \\ \hline
    ora
     & TIME
     & NN
    \\ \hline
\end{tabularx}

\subsection*{Indici}
%
% Compilare la seguente tabella, per ciascuna tabella del database in cui
% sono presenti degli indici.
% Descrivere le motivazioni che hanno portato alla creazione di un indice.
%
\begin{tabularx}{\linewidth}{|X|X|}
    \hline
    \multicolumn{2}{|>{\columncolor{tblhdrcolor}}l|}{
    \textbf{Tabella \textlangle{}nome\textrangle{}}} \\\hline
    \rowcolor{tblhdrcolor}
    \multicolumn{1}{|l|}{\textbf{Indice \textlangle{}nome\textrangle{}}}
     & \multicolumn{1}{|l|}{\textbf{Tipo}
        \footnote{IDX = index, UQ = unique, FT = full text, PR = primary.}
        \textbf{:}}
    \\\hline
    Colonna 1
     & \textlangle{}nome\textrangle{}
    \\ \hline
\end{tabularx}

\subsection*{Trigger}
%
% Descrivere quali trigger sono stati implementati, mostrando il codice SQL
% per la loro istanziazione. Si faccia riferimento al fatto che il DBMS di
% riferimento richiede di utilizzare trigger anche per realizzare vincoli di
% check ed asserzioni.
%

\begin{verbatim}
CREATE TRIGGER `cinemadb`.`Cinema_BEFORE_INSERT`
BEFORE INSERT ON `Cinema`
FOR EACH ROW
BEGIN
    IF (NEW.`chiusura` < NEW.`apertura`) THEN
        SIGNAL SQLSTATE '45001'
        SET MESSAGE_TEXT = 'L\'orario di chiusura non può precedere quello
                            di apertura';
    END IF;
END
\end{verbatim}

\begin{verbatim}
CREATE TRIGGER `cinemadb`.`Turni_BEFORE_INSERT`
BEFORE INSERT ON `Turni`
FOR EACH ROW
BEGIN
    IF (NEW.`durata` > TIME('08:00:00')) THEN
        SIGNAL SQLSTATE '45001'
        SET MESSAGE_TEXT = 'Impossibile creare un turno di più di 8 ore.';
    END IF;
END
\end{verbatim}

\begin{verbatim}
CREATE TRIGGER `cinemadb`.`Turni_BEFORE_INSERT_1` 
BEFORE INSERT ON `Turni` 
FOR EACH ROW
BEGIN
    DECLARE OreTotali TIME;
    SET OreTotali = (SELECT SEC_TO_TIME(SUM(TIME_TO_SEC(`Turni`.`durata`)))
                        FROM `Turni`
                        WHERE `Turni`.`dipendente` = NEW.`dipendente`
                            AND `Turni`.`giorno` = NEW.`giorno`);
    IF (OreTotali + NEW.`durata` > TIME('08:00:00')) THEN
        SIGNAL SQLSTATE '45001'
        SET MESSAGE_TEXT = 'La somma della durata dei turni nella giornata
                            supera le 8 ore.';
    END IF;
END
\end{verbatim}

\pagebreak
\begin{verbatim}
CREATE TRIGGER `cinemadb`.`Turni_BEFORE_INSERT_2`
BEFORE INSERT ON `Turni`
FOR EACH ROW
BEGIN
    DECLARE clash BOOL;
    SET clash = EXISTS (SELECT * 
                        FROM `Turni` 
                        WHERE `Turni`.`dipendente` = NEW.`dipendente`
                            AND `Turni`.`giorno` = NEW.`giorno`
                            AND `Turni`.`inizio` < 
                            (SEC_TO_TIME(TIME_TO_SEC(NEW.`inizio`) 
                            + TIME_TO_SEC(NEW.`durata`))) 
                            AND (SEC_TO_TIME(TIME_TO_SEC(`Turni`.`inizio`) 
                            + TIME_TO_SEC(`Turni`.`durata`))) > NEW.`inizio`);
    IF (clash) THEN
        SIGNAL SQLSTATE '45001'
        SET MESSAGE_TEXT = 'Il dipendente è già assegnato ad un turno
                            nell\'arco temporale selezionato.';
    END IF;
END
\end{verbatim}

\begin{verbatim}
CREATE TRIGGER `cinemadb`.`Turni_BEFORE_INSERT_3`
BEFORE INSERT ON `Turni`
FOR EACH ROW
BEGIN
    DECLARE ora_apertura_cinema TIME;
    DECLARE ora_chiusura_cinema TIME;
    SET ora_apertura_cinema = (SELECT `apertura`
                                FROM `Cinema`
                                WHERE `id` = NEW.`cinema`);
    SET ora_chiusura_cinema = (SELECT `chiusura`
                                FROM `Cinema`
                                WHERE `id` = NEW.`cinema`);
    IF (NEW.`inizio` < ora_apertura_cinema
        OR SEC_TO_TIME(TIME_TO_SEC(NEW.`inizio`)
        + TIME_TO_SEC(NEW.`durata`)) > ora_chiusura_cinema) THEN
        SIGNAL SQLSTATE '45001'
        SET MESSAGE_TEXT = 'Il cinema selezionato è chiuso nell\'intervallo
                            di tempo specificato.';
    END IF;
END
\end{verbatim}

\pagebreak
\begin{verbatim}
CREATE TRIGGER `cinemadb`.`Proiezioni_BEFORE_INSERT`
BEFORE INSERT ON `Proiezioni`
FOR EACH ROW
BEGIN
    DECLARE inizio_proiezione TIMESTAMP;
    DECLARE fine_proiezione TIMESTAMP;
    DECLARE fine_proiezione_prec TIMESTAMP;
    DECLARE inizio_proiezione_succ TIMESTAMP;
    SET inizio_proiezione = TIMESTAMP(NEW.`data`, NEW.`ora`);
    SET fine_proiezione = TIMESTAMP(NEW.`data`,
                                    NEW.`ora` + (SELECT `durata`
                                                 FROM `Film`
                                                 WHERE `id` = NEW.`film`));
    SET inizio_proiezione_succ = (SELECT TIMESTAMP(`data`, `ora`)
                                  FROM `Proiezioni`
                                  WHERE `cinema` = NEW.`cinema`
                                    AND `sala` = NEW.`sala`
                                    AND (`data` > NEW.`data`
                                        OR (`data` = NEW.`data`
                                            AND `ora` > NEW.`ora`))
                                  ORDER BY `data` ASC, `ora` ASC
                                  LIMIT 1);
    SET fine_proiezione_prec = (SELECT TIMESTAMP(`data`, `ora` + `durata`)
                                FROM `Proiezioni` JOIN `Film` on `id` = `film`
                                WHERE `cinema` = NEW.`cinema`
                                    AND `sala` = NEW.`sala`
                                    AND (`data` < NEW.`data`
                                        OR (`data` = NEW.`data`
                                            AND `ora` <= NEW.`ora`))
                                ORDER BY `data` DESC, `ora` DESC
                                LIMIT 1);
    IF ((fine_proiezione_prec IS NOT NULL
            AND fine_proiezione_prec > inizio_proiezione)
        OR (inizio_proiezione_succ IS NOT NULL
            AND inizio_proiezione_succ < fine_proiezione)) THEN
        SIGNAL SQLSTATE '45001'
        SET MESSAGE_TEXT = 'La sala selezionata è già impegnata in una
                            proiezione nell\'orario selezionato.';
    END IF;
END
\end{verbatim}

\pagebreak
\begin{verbatim}
CREATE TRIGGER `cinemadb`.`Proiezioni_BEFORE_INSERT_1`
BEFORE INSERT ON `Proiezioni`
FOR EACH ROW
BEGIN
    DECLARE ora_apertura_cinema TIME;
    DECLARE ora_chiusura_cinema TIME;
    DECLARE durata TIME;
    SET ora_apertura_cinema = (SELECT `apertura`
                                FROM `Cinema`
                                WHERE `id` = NEW.`cinema`);
    SET ora_chiusura_cinema = (SELECT `chiusura`
                                FROM `Cinema`
                                WHERE `id` = NEW.`cinema`);
    SET durata = (SELECT `durata` FROM `Film` WHERE `id` = NEW.`film`);
    IF (NEW.`ora` < ora_apertura_cinema
        OR SEC_TO_TIME(TIME_TO_SEC(NEW.`ora`)
        + TIME_TO_SEC(durata)) > ora_chiusura_cinema) THEN
        SIGNAL SQLSTATE '45001'
        SET MESSAGE_TEXT = 'Il cinema selezionato è chiuso nell\'intervallo
                            di tempo specificato.';
    END IF;
END
\end{verbatim}

\pagebreak
\subsection*{Eventi}
%
% Descrivere quali eventi sono stati implementati, mostrando il codice SQL
% per la loro istanziazione. Si descriva anche se gli eventi sono
% istanziati soltanto in fase di configurazione del sistema, o se alcuni
% eventi specifici vengono istanziati in maniera effimera durante
% l’esecuzione di alcune procedure.
%
\begin{verbatim}
CREATE EVENT `cinemadb`.`pulizia_prenotazioni`
ON SCHEDULE EVERY 1 MONTH
STARTS TIMESTAMP(DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL 1 MONTH), '%Y-%m-1'))
DO
    DELETE FROM `Prenotazioni` WHERE `data` < CURDATE();
\end{verbatim}

\begin{verbatim}
CREATE EVENT `cinemadb`.`pulizia_proiezioni`
ON SCHEDULE EVERY 1 DAY
STARTS TIMESTAMP(CURDATE())
DO
    DELETE FROM `Proiezioni` WHERE `data` < CURDATE();
\end{verbatim}

\subsection*{Viste}
%
% Mostrare e commentare il codice SQL necessario a creare tutte le viste
% necessarie per l’implementazione dell’applicazione.
%

\begin{verbatim}
CREATE VIEW `OrariCinema` AS
    SELECT `cinema`, `data`, MIN(`ora`) AS `inizio`,
        SEC_TO_TIME(MAX(TIME_TO_SEC(`ora`) + TIME_TO_SEC(`durata`))) AS `fine`
    FROM `Proiezioni` JOIN `Film` ON `id` = `film`
    GROUP BY `cinema`, `data`;
\end{verbatim}

\subsection*{Stored Procedures e transazioni}
%
% Mostrare e commentare le stored procedure che sono state realizzate per
% implementare la logica applicativa delle operazioni sui dati, evidenziando
% quando (e perché) sono state realizzate operazioni transazionali complesse.
%
